"use strict";(self.webpackChunkapache_teaclave_incubating=self.webpackChunkapache_teaclave_incubating||[]).push([[9766],{909:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>t,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"executing-wasm","title":"Executing WebAssembly in Teaclave","description":"Teaclave integrates WebAssembly Micro Runtime as an executor, which can","source":"@site/docs/executing-wasm.md","sourceDirName":".","slug":"/executing-wasm","permalink":"/docs/executing-wasm","draft":false,"unlisted":false,"editUrl":"https://github.com/apache/incubator-teaclave-website/tree/master/sgx-sdk-api-docs/docs/executing-wasm.md","tags":[],"version":"current","frontMatter":{"permalink":"/docs/executing-wasm"},"sidebar":"tutorialSidebar","previous":{"title":"Executing builtin-functions in Occlum","permalink":"/docs/executing-in-occlum"},"next":{"title":"Write Functions in Python","permalink":"/docs/functions-in-python"}}');var a=s(4848),i=s(8453);const t={permalink:"/docs/executing-wasm"},c="Executing WebAssembly in Teaclave",o={},l=[{value:"From C",id:"from-c",level:2},{value:"From Rust",id:"from-rust",level:2},{value:"References",id:"references",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"executing-webassembly-in-teaclave",children:"Executing WebAssembly in Teaclave"})}),"\n",(0,a.jsx)(n.p,{children:"Teaclave integrates WebAssembly Micro Runtime as an executor, which can\r\ninterpret WebAssembly bytecode in a sandboxed environment. Theoretically, source\r\ncode written in any language which can be compiled to WebAssembly should also be\r\nexecutable in Teaclave. However, in order to be more secure, Teaclave cannot\r\nprovide interfaces such as syscalls to legacy applications, so the source code\r\nshould:"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"Be self-contained: not depending on libraries which are not provided by\r\nTeaclave, including standard libraries."}),"\n",(0,a.jsx)(n.li,{children:"Contains no syscall: no system call-related code."}),"\n",(0,a.jsxs)(n.li,{children:["Implement required interface: exporting an ",(0,a.jsx)(n.code,{children:"int entrypoint(int argc, char* argv[])"})," function which is compatible with Teaclave WAMR calling convention\r\n(see examples for more details)."]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["Currently, ",(0,a.jsx)(n.a,{href:"../sdk/payload/wasm",children:"Teaclave file system APIs"})," are supported. We\r\nalso provide examples for compiling and executing from source code of various\r\nlanguages."]}),"\n",(0,a.jsxs)(n.p,{children:["::: tip NOTE\r\nIn current Teaclave client SDK, when passing arguments to the registered\r\nfunction, each ",(0,a.jsx)(n.code,{children:"(key, value)"})," pair is converted into two string pointers in\r\n",(0,a.jsx)(n.code,{children:"argv"})," and you should expect ",(0,a.jsx)(n.code,{children:"argc"})," is as twice as the actual number of\r\narguments. The calling convention is subject to further changes.\r\n:::"]}),"\n",(0,a.jsx)(n.h2,{id:"from-c",children:"From C"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"clang"})," supporting ",(0,a.jsx)(n.code,{children:"wasm32"})," can be used for compiling Teaclave-compatible WASM\r\nbytecode. Remember to add following options while compiling:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sh",children:"--target=wasm32 \\\r\n-nostdlib \\\r\n-Wl,--no-entry \\\r\n-Wl,--export-all, \\\r\n-Wl,--allow-undefined \n"})}),"\n",(0,a.jsxs)(n.p,{children:["You can also use ",(0,a.jsx)(n.code,{children:"clang"})," provided by\r\n",(0,a.jsx)(n.a,{href:"https://github.com/WebAssembly/wasi-sdk",children:"wasi-sdk"}),", and the option\r\n",(0,a.jsx)(n.code,{children:"--target=wasm32"})," is not needed for this version. We also provide an ",(0,a.jsx)(n.a,{href:"https://github.com/apache/incubator-teaclave/tree/master/examples/python/wasm_c_millionaire_problem_payload",children:"example\r\npayload written in\r\nC"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["Alternatively, C and C++ code can be compiled with ",(0,a.jsx)(n.a,{href:"https://ziglang.org",children:"zig"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sh",children:"zig cc  -Os --target=wasm32-freestanding -shared -o example.wasm example.c\r\nzig c++ -Os --target=wasm32-freestanding -shared -o example.wasm example.cpp\n"})}),"\n",(0,a.jsx)(n.h2,{id:"from-rust",children:"From Rust"}),"\n",(0,a.jsxs)(n.p,{children:["First of all, your cargo should support ",(0,a.jsx)(n.code,{children:"wasm32"})," target and ",(0,a.jsx)(n.code,{children:"wasm-gc"})," is\r\nrequired to reduce the size of generated binary. You can easily run the\r\nfollowing commands to install dependencies:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sh",children:"rustup target add wasm32-unknown-unknown\r\ncargo install wasm-gc\n"})}),"\n",(0,a.jsxs)(n.p,{children:["There should be an exported ",(0,a.jsx)(n.code,{children:"entrypoint"})," function in the source code, so you can\r\nsimply use ",(0,a.jsx)(n.code,{children:"cargo"})," to create a new library and generate it with ",(0,a.jsx)(n.code,{children:"cargo build --target wasm32-unknown-unknown"}),". Please also add ",(0,a.jsx)(n.code,{children:'crate-type = ["cdylib"]'})," in\r\nthe ",(0,a.jsx)(n.code,{children:"[lib]"})," section into your ",(0,a.jsx)(n.code,{children:"Cargo.toml"})," file to let cargo generate WASM file.\r\nTo reduce the size of WASM file, run:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sh",children:"cargo build --target wasm32-unknown-unknown --release\r\nwasm-gc target/wasm32-unknown-unknown/release/[WASM FILENAME]\n"})}),"\n",(0,a.jsxs)(n.p,{children:["For detailed optimization options and function signature, please refer to the\r\n",(0,a.jsx)(n.a,{href:"https://github.com/apache/incubator-teaclave/tree/master/examples/python/wasm_rust_psi_payload",children:"example payload"}),"."]}),"\n",(0,a.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://depth-first.com/articles/2020/06/29/compiling-rust-to-webassembly-a-simple-example/",children:"Compiling Rust to WebAssembly: A Simple Example"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>t,x:()=>c});var r=s(6540);const a={},i=r.createContext(a);function t(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:t(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);